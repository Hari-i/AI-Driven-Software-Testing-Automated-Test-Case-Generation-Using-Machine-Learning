<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Test Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #6b7280;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --dark: #111827;
            --light: #f9fafb;
            --border: #e5e7eb;
        }

        body {
            background: var(--light);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #374151;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background: white;
        }

        .card-header {
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--dark);
            padding: 1rem 1.5rem;
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: #3730a3;
            border-color: #3730a3;
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #047857;
            border-color: #047857;
        }

        .btn-warning {
            background: var(--warning);
            border-color: var(--warning);
        }

        .btn-warning:hover {
            background: #b45309;
            border-color: #b45309;
        }

        .btn-info {
            background: var(--secondary);
            border-color: var(--secondary);
        }

        .btn-info:hover {
            background: #4b5563;
            border-color: #4b5563;
        }

        textarea, .form-control {
            border-radius: 6px;
            border: 1px solid var(--border);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            transition: border-color 0.2s ease;
        }

        textarea:focus, .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        pre {
            background: #1f2937;
            border-radius: 6px;
            padding: 1.5rem;
            height: 400px;
            overflow: auto;
            border: 1px solid #374151;
        }

        .form-check-input:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--secondary);
            background: none;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            background: none;
        }

        .card-header-tabs {
            margin-bottom: 0;
            border-bottom: none;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-idle { background: #9ca3af; }
        .status-loading { background: var(--warning); }
        .status-success { background: var(--success); }
        .status-error { background: var(--danger); }
    </style>
</head>

<body>
    <div class="header">
        <div class="container">
            <h1 class="h2 fw-bold mb-2">AI Test Generator</h1>
            <p class="text-muted mb-0">Generate comprehensive Python tests with AI-powered analysis</p>
        </div>
    </div>

    <div class="container-fluid px-4">
        <!-- Input Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Python Code Input</span>
                        <div class="d-flex gap-2">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="explainToggle" checked>
                                <label class="form-check-label" for="explainToggle">Explanations</label>
                            </div>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="refineToggle">
                                <label class="form-check-label" for="refineToggle">Enhanced</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-8">
                                <textarea id="functionCode" class="form-control" rows="8" 
                                    placeholder="def calculate_sum(a, b):
    '''Calculate sum of two numbers'''
    if not isinstance(a, (int, float)) or not isinstance(b, (int, float)):
        raise TypeError('Arguments must be numbers')
    return a + b"></textarea>
                            </div>
                            <div class="col-lg-4">
                                <div class="mb-3">
                                    <label for="formFile" class="form-label">Upload Python File</label>
                                    <input class="form-control" type="file" id="formFile" accept=".py">
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="generateTests('unit')" id="unitBtn">
                                        Generate Unit Tests
                                    </button>
                                    <button class="btn btn-info" onclick="generateTests('coverage')" id="coverageBtn">
                                        Generate Coverage Tests
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Output Section with Tabs -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="outputTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests-pane" type="button" role="tab">
                                    Generated Tests
                                    <div class="status-badge status-idle ms-2" id="testsStatus"></div>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-pane" type="button" role="tab">
                                    Test Results
                                    <div class="status-badge status-idle ms-2" id="resultsStatus"></div>
                                </button>
                            </li>
                        </ul>
                        <div class="ms-auto d-flex gap-2">
                            <button class="btn btn-sm btn-success" onclick="runTests()" id="runBtn">
                                Run Tests
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="runMutationTests()" id="mutateBtn">
                                Mutation Testing
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="tab-content" id="outputTabContent">
                            <div class="tab-pane fade show active" id="tests-pane" role="tabpanel">
                                <pre class="m-0"><code id="generatedTests" class="language-python">// Generated tests will appear here...</code></pre>
                            </div>
                            <div class="tab-pane fade" id="results-pane" role="tabpanel">
                                <pre class="m-0"><code id="testResults" class="language-bash">// Test results will appear here...</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script>
        function setStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = `status-badge status-${status}`;
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                const originalText = button.textContent;
                button.innerHTML = '<span class="spinner me-2"></span>' + originalText;
            } else {
                button.disabled = false;
                button.innerHTML = button.innerHTML.replace('<span class="spinner me-2"></span>', '');
            }
        }

        document.getElementById('formFile').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                setStatus('inputStatus', 'loading');
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('functionCode').value = e.target.result;
                    setStatus('inputStatus', 'success');
                };
                reader.readAsText(file);
            }
        });

        async function generateTests(testType) {
            const functionCode = document.getElementById('functionCode').value;
            const explain = document.getElementById('explainToggle').checked;
            const refine = document.getElementById('refineToggle').checked;
            const generatedTestsElement = document.getElementById('generatedTests');
            const testResultsElement = document.getElementById('testResults');
            const buttonId = testType === 'unit' ? 'unitBtn' : 'coverageBtn';

            if (!functionCode.trim()) {
                alert('Please enter some Python code first!');
                return;
            }

            setStatus('testsStatus', 'loading');
            setButtonLoading(buttonId, true);
            generatedTestsElement.textContent = 'Generating tests with AI...';
            testResultsElement.textContent = '';
            Prism.highlightElement(generatedTestsElement);

            try {
                const response = await fetch('/generate_tests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        function_code: functionCode,
                        test_type: testType,
                        explain: explain,
                        refine: refine
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    generatedTestsElement.textContent = data.generated_tests;
                    setStatus('testsStatus', 'success');
                    // Switch to tests tab
                    document.getElementById('tests-tab').click();
                } else {
                    generatedTestsElement.textContent = 'Error: ' + data.error;
                    setStatus('testsStatus', 'error');
                }
            } catch (error) {
                generatedTestsElement.textContent = 'Network error: ' + error.message;
                setStatus('testsStatus', 'error');
            } finally {
                setButtonLoading(buttonId, false);
                Prism.highlightElement(generatedTestsElement);
            }
        }

        async function runTests() {
            const functionCode = document.getElementById('functionCode').value;
            const generatedTests = document.getElementById('generatedTests').textContent;
            const testResultsElement = document.getElementById('testResults');

            if (!functionCode || !generatedTests || generatedTests.includes('Generated tests will appear')) {
                alert('Please generate tests first!');
                return;
            }

            setStatus('resultsStatus', 'loading');
            setButtonLoading('runBtn', true);
            testResultsElement.textContent = 'Executing tests...';
            Prism.highlightElement(testResultsElement);

            try {
                const response = await fetch('/run_tests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ function_code: functionCode, generated_tests: generatedTests })
                });

                const data = await response.json();
                if (response.ok) {
                    let output = '';
                    if (data.stdout) output += data.stdout + '\n';
                    if (data.stderr) output += 'Errors:\n' + data.stderr + '\n';
                    output += `Exit Code: ${data.exit_code}`;
                    testResultsElement.textContent = output;
                    setStatus('resultsStatus', data.exit_code === 0 ? 'success' : 'error');
                    // Switch to results tab
                    document.getElementById('results-tab').click();
                } else {
                    testResultsElement.textContent = 'Error: ' + data.error;
                    setStatus('resultsStatus', 'error');
                }
            } catch (error) {
                testResultsElement.textContent = 'Network error: ' + error.message;
                setStatus('resultsStatus', 'error');
            } finally {
                setButtonLoading('runBtn', false);
                Prism.highlightElement(testResultsElement);
            }
        }

        async function runMutationTests() {
            const functionCode = document.getElementById('functionCode').value;
            const generatedTests = document.getElementById('generatedTests').textContent;
            const testResultsElement = document.getElementById('testResults');

            if (!functionCode || !generatedTests || generatedTests.includes('Generated tests will appear')) {
                alert('Please generate tests first!');
                return;
            }

            setStatus('resultsStatus', 'loading');
            setButtonLoading('mutateBtn', true);
            testResultsElement.textContent = 'Running mutation analysis...';
            Prism.highlightElement(testResultsElement);

            try {
                const response = await fetch('/run_mutation_tests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ function_code: functionCode, generated_tests: generatedTests })
                });

                const data = await response.json();
                if (response.ok) {
                    let output = 'Mutation Testing Results:\n\n';
                    if (data.success) {
                        output += data.output + '\n';
                        const summary = data.summary;
                        if (summary.total > 0) {
                            const survivalRate = (summary.survived / summary.total * 100).toFixed(1);
                            output += `\nSummary: ${summary.killed} killed, ${summary.survived} survived (${survivalRate}% survival rate)`;
                        }
                        setStatus('resultsStatus', summary.survived === 0 ? 'success' : 'warning');
                    } else {
                        output += `Error: ${data.error}`;
                        setStatus('resultsStatus', 'error');
                    }
                    testResultsElement.textContent = output;
                    // Switch to results tab
                    document.getElementById('results-tab').click();
                } else {
                    testResultsElement.textContent = 'Error: ' + data.error;
                    setStatus('resultsStatus', 'error');
                }
            } catch (error) {
                testResultsElement.textContent = 'Network error: ' + error.message;
                setStatus('resultsStatus', 'error');
            } finally {
                setButtonLoading('mutateBtn', false);
                Prism.highlightElement(testResultsElement);
            }
        }
    </script>
</body>

</html>